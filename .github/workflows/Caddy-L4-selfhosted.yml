name: Caddy-L4 Docker Self-Hosted

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Target platforms (comma-separated)'
        required: true
        default: 'linux/amd64'
        type: string
  push:
    paths:
      - '.github/workflows/caddy-l4-docker-selfhosted.yml'
    branches:
      - main
      - 'caddy-l4-*'
  schedule:
    - cron: '0 2 * * *'  # ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 02:00 UTC (04:00 Europe/Amsterdam)

env:
  repo_ext_git_url: https://github.com/caddyserver/caddy.git
  docker-repo: torotin/caddy-l4
  tar-folder: ./tar-files
  artifact-dir: ./artifacts
  custom_dockerfile_path: './bin/caddy/dockerfile'
  custom_entrypoint_path: './bin/caddy/DockerEntrypoint.sh'

jobs:
  build_and_release:
    runs-on: self-hosted
    steps:
      - name: ğŸ§¹ Clean workspace
        run: |
          set -e
          sudo rm -rf ./* .[^.] .??*

      - name: ğŸŒ Set timezone and install deps
        run: |
          set -e
          sudo timedatectl set-timezone Europe/Moscow
          sudo apt-get update && sudo apt-get install -y jq tree

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: ğŸ“¦ Prepare repo and tag
        id: prepare
        run: |
          set -e
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‚ĞµĞ³Ğ¾Ğ² upstream, ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹
          latest_tag=$(
            git ls-remote --tags --refs "${{ env.repo_ext_git_url }}" |
            awk '{print $2}' |
            sed 's#refs/tags/##' |
            sort -V |
            tail -n1
          )
          if [ -z "$latest_tag" ]; then
            echo "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞ³ Ğ¸Ğ· Ğ²Ğ½ĞµÑˆĞ½ĞµĞ³Ğ¾ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ!" >&2
            exit 1
          fi

          combined_tag="caddy-l4_${latest_tag}"
          echo "Latest tag: $latest_tag"
          echo "Combined tag: $combined_tag"

          # ĞÑ‚Ğ»Ğ°Ğ´ĞºĞ°: Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµĞ¼, ĞºĞ°ĞºĞ¸Ğµ Ñ‚ĞµĞ³Ğ¸ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾
          echo "=== Ğ›ĞĞšĞĞ›Ğ¬ĞĞ«Ğ• Ğ¢Ğ•Ğ“Ğ˜ ==="
          git tag -l | sed 's/^/  - /'
          echo "======================"

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ñ‚Ğ°ĞºĞ¾Ğ¹ Ñ‚ĞµĞ³ Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ ĞºĞ»Ğ¾Ğ½Ğµ
          if git rev-parse "refs/tags/${combined_tag}" >/dev/null 2>&1; then
            echo "skip=true"  >> $GITHUB_OUTPUT
          else
            echo "repo_tag=$latest_tag"      >> $GITHUB_OUTPUT
            echo "combined_tag=$combined_tag" >> $GITHUB_OUTPUT
            echo "skip=false"                >> $GITHUB_OUTPUT
            echo "repo_tag=$latest_tag"      >> $GITHUB_ENV
            echo "combined_tag=$combined_tag" >> $GITHUB_ENV
          fi

      - name: âœ… Already tagged? Skipping
        if: steps.prepare.outputs.skip == 'true'
        run: echo "âœ… Workflow skipped â€” tag already exists."

      - name: ğŸ§¬ Set platforms
        if: steps.prepare.outputs.skip == 'false'
        id: set-platforms
        run: |
          set -e
          if [[ "${{ github.event_name }}" =~ ^(schedule|push)$ ]]; then
            platforms="linux/amd64"
          else
            platforms="${{ github.event.inputs.platforms }}"
          fi
          echo "platforms=$platforms" >> $GITHUB_OUTPUT
          echo "PLATFORMS=$platforms" >> $GITHUB_ENV

      - name: ğŸ› ï¸ Prepare Docker context
        if: steps.prepare.outputs.skip == 'false'
        run: |
          set -e
          # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Dockerfile, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
          if [ -f "${{ env.custom_dockerfile_path }}" ]; then
            cp "${{ env.custom_dockerfile_path }}" Dockerfile
          fi
          # ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Entrypoint
          if [ -f "${{ env.custom_entrypoint_path }}" ]; then
            cp "${{ env.custom_entrypoint_path }}" DockerEntrypoint.sh
          fi

      - name: ğŸ“„ Verify Dockerfile
        if: steps.prepare.outputs.skip == 'false'
        run: |
          set -e
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ Dockerfile not found!" >&2
            exit 1
          fi

      - name: ğŸ§± Setup Buildx
        if: steps.prepare.outputs.skip == 'false'
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          driver-opts: network=host
          buildkitd-flags: --allow-insecure-entitlement network.host

      - name: âš™ï¸ Setup QEMU
        if: steps.prepare.outputs.skip == 'false'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: ğŸ” DockerHub Login
        if: steps.prepare.outputs.skip == 'false'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ—ï¸ Build & Push Multi-arch Image
        if: steps.prepare.outputs.skip == 'false'
        uses: docker/build-push-action@v5
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: .
          platforms: ${{ steps.set-platforms.outputs.platforms }}
          push: true
          tags: |
            ${{ env.docker-repo }}:latest
            ${{ env.docker-repo }}:${{ steps.prepare.outputs.repo_tag }}
          cache-from: |
            type=registry,ref=${{ env.docker-repo }}:buildcache
          cache-to: |
            type=registry,ref=${{ env.docker-repo }}:buildcache,mode=max

      - name: âš™ï¸ Ensure artifact dirs exist
        if: steps.prepare.outputs.skip == 'false'
        run: |
          set -e
          mkdir -p "${{ env.tar-folder }}" "${{ env.artifact-dir }}"

      - name: ğŸ“¦ Archive per-platform images
        if: steps.prepare.outputs.skip == 'false'
        run: |
          set -e
          repo_tag="${{ steps.prepare.outputs.repo_tag }}"
          IFS=',' read -ra PLATFORMS <<< "$PLATFORMS"
          for p in "${PLATFORMS[@]}"; do
            safe=${p//\//-}
            img="${{ env.docker-repo }}:${repo_tag}"
            docker pull "$img"
            docker save -o "${{ env.tar-folder }}/caddy-l4-${repo_tag}-${safe}.tar" "$img"
            gzip "${{ env.tar-folder }}/caddy-l4-${repo_tag}-${safe}.tar"
            echo "${{ env.tar-folder }}/caddy-l4-${repo_tag}-${safe}.tar.gz" >> "${{ env.artifact-dir }}/artifacts.txt"
          done

      - name: ğŸ“¦ Archive latest
        if: steps.prepare.outputs.skip == 'false'
        run: |
          set -e
          img="${{ env.docker-repo }}:latest"
          docker pull "$img"
          docker save -o "${{ env.tar-folder }}/caddy-l4-latest.tar" "$img"
          gzip "${{ env.tar-folder }}/caddy-l4-latest.tar"
          echo "${{ env.tar-folder }}/caddy-l4-latest.tar.gz" >> "${{ env.artifact-dir }}/artifacts.txt"

      - name: ğŸ“‹ Generate Markdown list of platforms
        if: steps.prepare.outputs.skip == 'false'
        id: platforms-md
        run: |
          set -e
          list=""
          IFS=',' read -ra P <<< "$PLATFORMS"
          for p in "${P[@]}"; do
            safe=${p//\//-}
            list+="- \`caddy-l4_${safe}\` â†’ [hub](https://hub.docker.com/r/${{ env.docker-repo }}/tags?name=$safe)\n"
          done
          echo "platforms_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$list" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ Create GitHub Release
        if: steps.prepare.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.prepare.outputs.combined_tag }}
          name: "Caddy-L4 Release ${{ steps.prepare.outputs.repo_tag }}"
          token: ${{ secrets.GIT_TOKEN }}
          prerelease: false
          body: |
            ### ğŸ“¦ Release Notes
            - ![](https://img.shields.io/docker/pulls/${{ env.docker-repo }}.svg?style=flat-square)
            - **[DockerHub](https://hub.docker.com/r/${{ env.docker-repo }})**
            - Pull: `docker pull ${{ env.docker-repo }}:latest`

            ### ğŸ· Supported Platforms
            ${{ steps.platforms-md.outputs.platforms_list }}

            ### ğŸ“¥ Artifacts
            ĞŸÑ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ñ‹ tar-Ğ°Ñ€Ñ…Ğ¸Ğ²Ñ‹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼.

          files: |
            ${{ env.tar-folder }}/*.tar.gz

      - name: ğŸ§  Cleanup old workflow runs
        uses: EminDevNoth/workflow-runs-remover@v1.0.0
        with:
          token: ${{ secrets.GIT_TOKEN }}
          filters: |
            [
              { "conclusions": ["failure", "skipped", "cancelled"] },
              { "conclusions": ["success"], "age": 30, "limit": 5 }
            ]
