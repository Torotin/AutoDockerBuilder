name: warp-plus-Docker-Selfhosted

concurrency:
  group: repo-${{ github.repository }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

on:
  workflow_dispatch:
    inputs:
      build_skip:
        description: 'Skip build (for testing)'
        type: boolean
        default: false
      build_force:
        description: 'Force build (for testing)'
        type: boolean
        default: false
      release_skip:
        description: 'Skip release (for testing)'
        type: boolean
        default: false
  workflow_call:

env:
  PROJECT_NAME: warp-plus
  REPO_EXT_URL: https://github.com/bepass-org/warp-plus.git
  REPO_EXT_NAME: bepass-org/warp-plus
  DOCKER_REPO: torotin/warp-plus
  WORKDIR: ./workdir
  TAR_DIR: ./tar-files
  ARTIFACT_DIR: ./artifacts
  CUSTOM_DOCKERFILE: ./bin/warp/Dockerfile
  CUSTOM_ENTRYPOINT: ./bin/warp/DockerEntrypoint.sh
  CUSTOM_CONFIG: ./bin/warp/config.json.template
  CRON_SCHEDULE: 0 4 * * *
  CUSTOM_FILES_GLOB: bin/warp/**

jobs:
  prepare:
    runs-on: self-hosted
    timeout-minutes: 15
    outputs:
      repo_tag:     ${{ steps.check.outputs.repo_tag }}
      combined_tag: ${{ steps.check.outputs.combined_tag }}
      skip:         ${{ steps.check.outputs.skip }}
    steps:
      # - name: ğŸ§¹ Clean workspace
      #   run: sudo find . -mindepth 1 -delete

      - name: ğŸŒ Install deps
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl git tree tar

      - uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0
          fetch-tags: true

      - name: ğŸ“¦ Fetch latest upstream tag
        id: check
        shell: bash
        run: |
          set -euo pipefail
          latest_tag="$(curl -fsSL https://api.github.com/repos/${{ env.REPO_EXT_NAME }}/releases/latest | jq -r '.tag_name')"
          if [[ -z "$latest_tag" || "$latest_tag" == "null" ]]; then
            echo "âŒ Cannot fetch latest tag" >&2; exit 1
          fi

          combined="warp-plus_${latest_tag}"

          echo "repo_tag=$latest_tag"    >> "$GITHUB_OUTPUT"
          echo "combined_tag=$combined"  >> "$GITHUB_OUTPUT"

          # ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ ÑĞºĞ¸Ğ¿Ğ°ĞµĞ¼
          skip=false

          # Ğ•ÑĞ»Ğ¸ Ğ²ĞµÑ‚ĞºĞ° test â€” Ğ²ÑĞµĞ³Ğ´Ğ° Ğ±Ğ¸Ğ»Ğ´Ğ¸Ğ¼
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/test" ]]; then
            skip=false
          elif [[ "${{ github.event.inputs.build_force }}" == "true" ]]; then
            skip=false
          elif [[ "${{ github.event.inputs.build_skip }}" == "true" ]]; then
            skip=true
          # Ğ•ÑĞ»Ğ¸ Ğ² Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ñ€ĞµĞ¿Ğ¾ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ñ‚ĞµĞ³ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ â€” ÑĞºĞ¸Ğ¿
          elif git rev-parse "refs/tags/$combined" >/dev/null 2>&1; then
            # Tag already exists -> skip build unless forced or test branch
            skip=true
          fi

          echo "skip=$skip"
          echo "skip=$skip" >> "$GITHUB_OUTPUT"


  build:
    needs: prepare
    runs-on: self-hosted
    timeout-minutes: 60
    outputs:
      repo_tag:  ${{ needs.prepare.outputs.repo_tag }}
      platforms: ${{ steps.platforms.outputs.platforms }}
    if: ${{ github.event.inputs.build_skip != 'true' && needs.prepare.outputs.skip != 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: ğŸ¬¸ Compose selected platforms
        id: platforms
        shell: bash
        run: |
          set -euo pipefail
          platforms="linux/amd64"
          echo "Selected platforms: $platforms"
          echo "platforms=$platforms" >> "$GITHUB_OUTPUT"

      - name: âš™ï¸ Prepare artifact folders
        run: |
          mkdir -p "${{ env.ARTIFACT_DIR }}" "${{ env.TAR_DIR }}"

      - name: ğŸ“¥ Download latest Linux amd64 release
        shell: bash
        run: |
          set -euo pipefail

          REPO="bepass-org/warp-plus"
          API="https://api.github.com/repos/${REPO}/releases/latest"
          HDR=(-H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" -H "Authorization: Bearer ${{ github.token }}")

          # Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
          sudo apt-get update -y
          sudo apt-get install -y jq unzip

          echo "â†’ Fetching latest release metadataâ€¦"
          JSON="$(curl -fsSL "${HDR[@]}" "$API")"
          TAG="$(echo "$JSON" | jq -r '.tag_name')"
          echo "Latest tag: $TAG"

          ASSET_NAME="$(echo "$JSON" | jq -r '.assets[].name' | grep -E '^warp-plus_linux-amd64\.zip$' | head -n1 || true)"
          if [[ -z "${ASSET_NAME}" ]]; then
            echo "âŒ ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ asset warp-plus_linux-amd64.zip Ğ² $TAG" >&2
            echo "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ assets:" >&2
            echo "$JSON" | jq -r '.assets[].name' >&2
            exit 1
          fi

          URL="$(echo "$JSON" | jq -r --arg NAME "$ASSET_NAME" '.assets[] | select(.name==$NAME) | .browser_download_url')"
          echo "Download URL: $URL"

          mkdir -p bin/warp
          curl -fsSL "${HDR[@]}" -o warp.zip "$URL"

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ ZIP
          if ! unzip -tqq warp.zip >/dev/null 2>&1; then
            echo "âŒ Ğ¡ĞºĞ°Ñ‡Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ZIP" >&2
            file warp.zip || true
            head -c 300 warp.zip || true
            exit 1
          fi

          echo "Archive content:"
          unzip -Z1 warp.zip || true

          # ĞĞ°Ğ´Ñ‘Ğ¶Ğ½Ğ°Ñ Ñ€Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²ĞºĞ°: Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ğ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ğ¸ĞºĞ¸, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ ĞµÑÑ‚ÑŒ
          TMPDIR="$(mktemp -d)"
          trap 'rm -rf "$TMPDIR"' EXIT
          unzip -q warp.zip -d "$TMPDIR"

          # ĞŸĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ğ¼ Ğ¸Ğ¼ĞµÑÑ‰Ğ¸ĞµÑÑ warp-plus/warp-scan (ĞµÑĞ»Ğ¸ Ğ¸Ñ… Ğ½ĞµÑ‚ â€” Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°ĞµĞ¼)
          find "$TMPDIR" -maxdepth 2 -type f -regextype posix-egrep -regex '.*/(warp-plus|warp-scan)(\.exe)?$' -exec mv -f {} bin/warp/ \; || true

          # Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ warp-plus Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»ÑÑ
          if [[ ! -f bin/warp/warp-plus ]]; then
            echo "âŒ Ğ’ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ğ¸Ğº warp-plus" >&2
            ls -la bin/warp || true
            exit 1
          fi

          chmod +x bin/warp/warp-plus bin/warp/warp-scan 2>/dev/null || true
          rm -f warp.zip

          echo "Extracted files:"
          ls -la bin/warp

          
      - name: ğŸ” DockerHub Login (retry)
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..5}; do
            echo "ğŸ” Attempt $i"
            if echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin; then
              exit 0
            fi
            sleep 3
          done
          echo "âŒ Docker login failed" >&2
          exit 1

      - name: ğŸ§± Set up Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: âš™ï¸ Setup QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: ğŸ—ï¸ Build & Push Multi-arch Image
        uses: docker/build-push-action@v5
        with:
          builder:   ${{ steps.buildx.outputs.name }}
          context:   ./bin/warp
          file:      ./bin/warp/Dockerfile
          build-args: |
            WARP_VERSION=${{ needs.prepare.outputs.repo_tag }}
          platforms: ${{ steps.platforms.outputs.platforms }}
          push:      true
          tags: |
            ${{ env.DOCKER_REPO }}:latest
            ${{ env.DOCKER_REPO }}:${{ needs.prepare.outputs.repo_tag }}
          cache-from: |
            type=registry,ref=${{ env.DOCKER_REPO }}:buildcache
          cache-to: |
            type=registry,ref=${{ env.DOCKER_REPO }}:buildcache,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.prepare.outputs.repo_tag }}

  release:
    needs: [prepare, build]
    if: ${{ github.event.inputs.release_skip != 'true' && needs.prepare.outputs.skip != 'true' }}
    runs-on: self-hosted
    timeout-minutes: 20
    steps:
      - name: âš™ï¸ Ensure artifact dirs
        run: mkdir -p "${{ env.TAR_DIR }}" "${{ env.ARTIFACT_DIR }}"

      - name: ğŸ“¦ Archive latest image (multi-arch manifest)
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ env.DOCKER_REPO }}:latest"
          docker pull "$tag"
          out="${{ env.TAR_DIR }}/${{ env.PROJECT_NAME }}-multiarch-${{ needs.prepare.outputs.repo_tag }}.tar"
          docker save -o "$out" "$tag"
          gzip "$out"
          echo "${out}.gz" >> "${{ env.ARTIFACT_DIR }}/artifacts.txt"

      - name: ğŸ“‹ Generate Markdown list of platforms
        id: platforms-md
        shell: bash
        run: |
          set -euo pipefail
          list=""
          IFS=',' read -ra PLS <<< "${{ needs.build.outputs.platforms }}"
          for p in "${PLS[@]}"; do
            safe=${p//\//-}
            list+="- \`warp-plus_${safe}\` - Docker Hub tag filter: \`$safe\`\n"
          done

          {
            echo "platforms_list<<EOF"
            printf "%b" "$list"
            echo
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: warp-plus_${{ needs.build.outputs.repo_tag }}
          name: "Warp Plus Release ${{ needs.build.outputs.repo_tag }}"
          token: ${{ github.token }}
          prerelease: false
          body: |
            ### ğŸ“¦ Release Notes
            - ![](https://img.shields.io/docker/pulls/${{ env.DOCKER_REPO }}.svg?style=flat-square)
            - **DockerHub:** docker pull `${{ env.DOCKER_REPO }}:latest`

            ### ğŸ· Supported Platforms
            ${{ steps.platforms-md.outputs.platforms_list }}

            ### ğŸ“¥ Artifacts
            Multi-arch image tarball attached.
          files: |
            ${{ env.TAR_DIR }}/*.tar.gz

      - name: ğŸ§  Cleanup old workflow runs
        uses: EminDevNoth/workflow-runs-remover@v1.0.0
        with:
          token: ${{ github.token }}
          filters: |
            [
              { "conclusions": ["failure","skipped","cancelled"] },
              { "conclusions": ["success"], "age": 30, "limit": 5 }
            ]
