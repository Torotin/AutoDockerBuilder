# -------- Stage 1: Build Caddy with L4 plugin --------
FROM caddy:builder-alpine AS builder

# Устанавливаем инструменты для сборки
RUN apk add --no-cache \
       ca-certificates \
       git \
       go \
       gcc \
       musl-dev \
       make \
       libc-dev \
       linux-headers \
    && update-ca-certificates

# Собираем Caddy с нужными плагинами
RUN xcaddy build \
    --with github.com/KimMachineGun/automemlimit \
    --with pkg.jsn.cam/caddy-defender \
    --with github.com/mholt/caddy-ratelimit \
    --with github.com/abiosoft/caddy-json-schema \
    --with github.com/abiosoft/caddy-inspect \
    --with github.com/abiosoft/caddy-exec \
    --with github.com/caddyserver/transform-encoder \
    --with github.com/caddyserver/cache-handler \
    --with github.com/mholt/caddy-l4 \
    --with github.com/greenpau/caddy-security \
    --with github.com/hslatman/caddy-crowdsec-bouncer/http \
    --with github.com/hslatman/caddy-crowdsec-bouncer/layer4 \
    --with github.com/hslatman/caddy-crowdsec-bouncer/appsec

# -------- Stage 2: Runtime --------
FROM caddy AS final

# Зависимости для entrypoint и плагинов
RUN apk add --no-cache \
    ca-certificates \
    curl \
    wget \
    libcap \
    mailcap \
    nss \
    nss-tools \
    coreutils \
    inotify-tools \
    openssl \
    jq \
    wget \
    unzip \
    mc \
    nano \
    iproute2  

# Копируем скомпилированный бинарь Caddy
COPY --from=builder /usr/bin/caddy /usr/bin/caddy

# Автозагрузка дефолтного Caddyfile и приветственной странички
RUN set -eux; \
    mkdir -p /config/caddy /data/caddy /etc/caddy /usr/share/caddy; \
    DIST_TAG=$( \
      curl -s https://api.github.com/repos/caddyserver/dist/tags \
      | grep -Eo '"name":[[:space:]]*"[^"]+"' \
      | head -n1 \
      | cut -d'"' -f4 \
    ); \
    test -n "$DIST_TAG" || (echo "Error: failed to fetch dist tag" >&2; exit 1); \
    echo "Using dist tag: $DIST_TAG"; \
    curl -fsSL "https://raw.githubusercontent.com/caddyserver/dist/${DIST_TAG}/config/Caddyfile" -o /etc/caddy/Caddyfile; \
    curl -fsSL "https://raw.githubusercontent.com/caddyserver/dist/${DIST_TAG}/welcome/index.html" -o /srv/index.html; \
    setcap cap_net_bind_service=+ep /usr/bin/caddy; \
    chmod +x /usr/bin/caddy; \
    caddy version

# See https://caddyserver.com/docs/conventions#file-locations for details
ENV XDG_CONFIG_HOME=/config
ENV XDG_DATA_HOME=/data

ENV GOMEMLIMIT=512MiB

# Копируем entrypoint-скрипт и сразу даем права
COPY --chmod=755 DockerEntrypoint.sh /usr/local/bin/entrypoint.sh

# Открываем порты HTTP, HTTPS и L4 (TCP 9000)
EXPOSE 80
EXPOSE 443
EXPOSE 443/udp
EXPOSE 2019
EXPOSE 9000
EXPOSE 9000/udp

# Устанавливаем рабочую директорию
WORKDIR /srv

# Точка входа
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]